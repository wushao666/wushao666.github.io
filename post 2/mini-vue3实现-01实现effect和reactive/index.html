<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>01-vue3å®ç°effectå’Œreactive - å´å°‘åœ¨Coding</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="å´å°‘æ—" /><meta name="description" content="mini-vueåˆå§‹åŒ– æœ¬ç³»åˆ—å°†ä¼šå®ç°ä¸€ä¸ªmini ğŸ˜Šçš„vue3æ¡†æ¶ï¼Œä½†æ˜¯åœ¨å¼€å§‹å†™ä»£ç ä¹‹å‰éœ€è¦åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œå®‰è£…ç›¸å…³ä¾èµ– å®‰è£…typescrip" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="http://wushao666.github.io/post/mini-vue3%E5%AE%9E%E7%8E%B0-01%E5%AE%9E%E7%8E%B0effect%E5%92%8Creactive/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="01-vue3å®ç°effectå’Œreactive" />
<meta property="og:description" content="mini-vueåˆå§‹åŒ– æœ¬ç³»åˆ—å°†ä¼šå®ç°ä¸€ä¸ªmini ğŸ˜Šçš„vue3æ¡†æ¶ï¼Œä½†æ˜¯åœ¨å¼€å§‹å†™ä»£ç ä¹‹å‰éœ€è¦åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œå®‰è£…ç›¸å…³ä¾èµ– å®‰è£…typescrip" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://wushao666.github.io/post/mini-vue3%E5%AE%9E%E7%8E%B0-01%E5%AE%9E%E7%8E%B0effect%E5%92%8Creactive/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-10-08T22:27:32+08:00" />
<meta property="article:modified_time" content="2022-10-08T22:27:32+08:00" />

<meta itemprop="name" content="01-vue3å®ç°effectå’Œreactive">
<meta itemprop="description" content="mini-vueåˆå§‹åŒ– æœ¬ç³»åˆ—å°†ä¼šå®ç°ä¸€ä¸ªmini ğŸ˜Šçš„vue3æ¡†æ¶ï¼Œä½†æ˜¯åœ¨å¼€å§‹å†™ä»£ç ä¹‹å‰éœ€è¦åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œå®‰è£…ç›¸å…³ä¾èµ– å®‰è£…typescrip"><meta itemprop="datePublished" content="2022-10-08T22:27:32+08:00" />
<meta itemprop="dateModified" content="2022-10-08T22:27:32+08:00" />
<meta itemprop="wordCount" content="2383">
<meta itemprop="keywords" content="vue3," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="01-vue3å®ç°effectå’Œreactive"/>
<meta name="twitter:description" content="mini-vueåˆå§‹åŒ– æœ¬ç³»åˆ—å°†ä¼šå®ç°ä¸€ä¸ªmini ğŸ˜Šçš„vue3æ¡†æ¶ï¼Œä½†æ˜¯åœ¨å¼€å§‹å†™ä»£ç ä¹‹å‰éœ€è¦åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œå®‰è£…ç›¸å…³ä¾èµ– å®‰è£…typescrip"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">å´å°‘åœ¨Coding</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">å´å°‘åœ¨Coding</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">01-vue3å®ç°effectå’Œreactive</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-10-08 </span>
        <div class="post-category">
            <a href="/categories/vue/"> vue </a>
            </div>
          <span class="more-meta"> çº¦ 2383 å­— </span>
          <span class="more-meta"> é¢„è®¡é˜…è¯» 5 åˆ†é’Ÿ </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#mini-vueåˆå§‹åŒ–">mini-vueåˆå§‹åŒ–</a>
      <ul>
        <li><a href="#ç›®å½•ç»“æ„">ç›®å½•ç»“æ„</a></li>
      </ul>
    </li>
    <li><a href="#vue3åŸºç¡€æ¦‚è¿°">vue3åŸºç¡€æ¦‚è¿°</a>
      <ul>
        <li><a href="#å®ç°reactive">å®ç°<code>reactive</code></a></li>
        <li><a href="#å®ç°effect">å®ç°<code>effect</code></a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="mini-vueåˆå§‹åŒ–">mini-vueåˆå§‹åŒ–</h2>
<p>æœ¬ç³»åˆ—å°†ä¼šå®ç°ä¸€ä¸ªmini ğŸ˜Šçš„vue3æ¡†æ¶ï¼Œä½†æ˜¯åœ¨å¼€å§‹å†™ä»£ç ä¹‹å‰éœ€è¦åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œå®‰è£…ç›¸å…³ä¾èµ–</p>
<ol>
<li>å®‰è£…<code>typescript</code>ï¼Œå› ä¸ºæˆ‘ä»¬è¦ç”¨tsæ¥å®ç°ï¼Œè™½ç„¶åªæ˜¯è½»é‡çº§tsä½“éªŒï¼Œç„¶åæ‰èƒ½åˆå§‹åŒ–<code>tsc --init</code>ï¼Œç”Ÿæˆtsconfig.json</li>
<li>å®‰è£…<code>jest</code>ï¼Œåšæµ‹è¯•ç”¨</li>
<li>å®‰è£…jesté…å¥—ä½¿ç”¨çš„<code>babel</code>, è¯¦è§jestå®˜ç½‘</li>
<li>åˆ›å»º<code>babel.config.js</code></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">presets</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">[</span><span class="s2">&#34;@babel/preset-env&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">targets</span><span class="o">:</span> <span class="p">{</span> <span class="nx">node</span><span class="o">:</span> <span class="s2">&#34;current&#34;</span> <span class="p">}</span> <span class="p">}],</span>
    <span class="s2">&#34;@babel/preset-typescript&#34;</span><span class="p">,</span>
  <span class="p">],</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>ä¿®æ”¹<code>tsconfig.json</code>ï¼Œæš‚æ—¶å…ˆæ”¹è¿™å‡ ä¸ª:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="s2">&#34;target&#34;</span><span class="o">:</span> <span class="s2">&#34;es2016&#34;</span><span class="p">,</span> 
<span class="s2">&#34;module&#34;</span><span class="o">:</span> <span class="s2">&#34;commonjs&#34;</span><span class="p">,</span> 
<span class="s2">&#34;types&#34;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;jest&#34;</span><span class="p">],</span>
</code></pre></td></tr></table>
</div>
</div><p>åé¢è¿˜ä¼šæ”¹å¾ˆå¤šâ€¦â€¦</p>
<ol start="5">
<li>ç¼ºå•¥ä¾èµ–å®‰è£…å•¥ä¾èµ–</li>
</ol>
<h3 id="ç›®å½•ç»“æ„">ç›®å½•ç»“æ„</h3>
<ol>
<li>æ ¹ç›®å½•ä¸‹åˆ›å»º<code>src</code>ç›®å½•ï¼Œåˆ›å»º<code>reactivity</code>å­ç›®å½•ï¼Œæ¥ç€åœ¨<code>reactivityç›®å½•ä¸‹</code>åˆ›å»º<code>test</code>å­ç›®å½•</li>
<li>åœ¨testç›®å½•ä¸‹åˆ›å»º<code>index.spec.ts</code>ï¼Œå†™ç‚¹ä¸œè¥¿æµ‹è¯•ä¸€ä¸‹<code>jestå¥½ç”¨ä¸</code></li>
</ol>
<h2 id="vue3åŸºç¡€æ¦‚è¿°">vue3åŸºç¡€æ¦‚è¿°</h2>
<p>vue3æœ‰ä¸‰å¤§æ ¸å¿ƒï¼š reactivity å“åº”å¼æ¨¡å—ã€runtime è¿è¡Œæ—¶æ¨¡å—ï¼ˆåŒ…æ‹¬elementåˆå§‹åŒ–å’Œæ›´æ–°ï¼‰ã€compiler ç¼–è¯‘æ¨¡å—ã€‚
æˆ‘ä»¬å…ˆä»reactivityæ¨¡å—å¼€å§‹è¿›è¡Œï¼Œä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª<code>reactivity</code>ç›®å½•ã€‚</p>
<h3 id="å®ç°reactive">å®ç°<code>reactive</code></h3>
<p><code>reactive</code>æ˜¯å“åº”å¼æ¨¡å—çš„åŸºç¡€çš„åŸºç¡€ï¼Œä¹Ÿæ˜¯æœ‰åˆ«äº<code>vue2</code>çš„æœ¬è´¨æ‰€åœ¨ï¼Œæˆ‘ä»¬å®ç°çš„æ‰€æœ‰è¿‡ç¨‹éƒ½æ˜¯æµ‹è¯•å…ˆè¡Œï¼Œå…ˆçœ‹çœ‹æˆ‘ä»¬æ­£å¸¸æ˜¯æ€ä¹ˆä½¿ç”¨çš„ï¼Œå†å»ä¸€æ­¥ä¸€æ­¥çš„å®ç°å®ƒã€‚</p>
<ol>
<li><code>reactivityç›®å½•</code>åˆ›å»º<code>reactive.ts</code>ï¼Œ<code>testç›®å½•</code>åˆ›å»º<code>reactive.spec.ts</code>ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="c1">// reactive.spec.ts
</span><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">reactive</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;../reactive&#34;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s2">&#34;reactive&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="s2">&#34;happy path&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">origin</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;foo&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">observed</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">origin</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">observed</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">origin</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">observed</span><span class="p">.</span><span class="nx">foo</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>æ ¹æ®è¿™ä¸ªæµ‹è¯•ä»£ç çš„<code>happy path</code>ï¼Œä¹Ÿå°±æ˜¯æ‰€æµ‹è¯•æ¨¡å—çš„æ ¸å¿ƒæµç¨‹ï¼Œæˆ‘ä»¬æœŸæœ›<code>reactive</code>å‡½æ•°ï¼Œå¯ä»¥ï¼š</p>
<ul>
<li>ä½¿ä¸€ä¸ªæ™®é€šå¯¹è±¡å˜æˆå“åº”å¼çš„ï¼Œå¹¶ä¸”å’ŒåŸæ¥ä¸ç›¸ç­‰</li>
<li>èƒ½å¤Ÿæ­£å¸¸è®¿é—®åŸå¯¹è±¡çš„å±æ€§å€¼</li>
</ul>
<ol start="2">
<li>ä»£ç†å¯¹è±¡ï¼Œä½¿ç”¨<code>proxy</code>æ¥å®ç°ï¼Œæœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªç»è¿‡æˆ‘ä»¬ä»£ç†å¤„ç†åçš„æ–°çš„å¯¹è±¡ï¼Œå¾ˆæ˜æ˜¾è¿™ä¸¤ä¸ªä¸ç›¸ç­‰äº†å°±ï¼Œä¸€ä¸ªåŸºç¡€ç‰ˆçš„<code>proxy</code>å†™æ³•å¦‚ä¸‹ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="c1">// reactive.ts
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">reactive</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Proxy</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">get</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// å½“æˆ‘ä»¬è·å–å€¼çš„æ—¶å€™è§¦å‘è¿™é‡Œgetterå¤„ç†å™¨ï¼Œé€šå¸¸ç”¨æ¥æ”¶é›†ä¾èµ–
</span><span class="c1"></span>      <span class="nx">trigger</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="c1">// TODO åœ¨effectä¸­å®ç°
</span><span class="c1"></span>      <span class="c1">// proxyä¸ºä»€ä¹ˆè¦é…åˆä½¿ç”¨Reflectè¯¦è§åé¢çš„åˆ†æ
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">Reflect</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">value</span>
    <span class="p">},</span>
    <span class="nx">set</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// å½“æˆ‘ä»¬è®¾ç½®æ—¶è§¦å‘è¿™é‡Œçš„setterå¤„ç†å™¨ï¼Œè§¦å‘ä¸Šé¢æ”¶é›†åˆ°çš„ä¾èµ–
</span><span class="c1"></span>      <span class="nx">trigger</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="c1">// TODO åœ¨effectä¸­å®ç°
</span><span class="c1"></span>      <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">Reflect</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>

      <span class="k">return</span> <span class="nx">result</span>
    <span class="p">},</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="p">{</span>
  <span class="nx">reactive</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä»¥ä¸Šæ˜¯æœ€åŸºç¡€çš„ä»£ç†å®ç°ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜éœ€è¦æ”¶é›†å’Œè§¦å‘ä¾èµ–çš„é€»è¾‘ï¼Œè¿™å°±éœ€è¦ç”¨åˆ°æ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªæ¦‚å¿µ<code>effect</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¼ºå¤§çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œå¯ä»¥å®ç°ä¾èµ–æ”¶é›†ä¸è§¦å‘ç­‰ç­‰å…¶ä»–å¤æ‚çš„æ“ä½œã€‚</p>
<h3 id="å®ç°effect">å®ç°<code>effect</code></h3>
<p>åœ¨<code>effect</code>ä¸­æˆ‘ä»¬å¤„ç†æ‰€æœ‰ä¸ä¾èµ–æœ‰å…³çš„æ“ä½œï¼Œç›¸å½“äºæ˜¯è§£è€¦äº†ï¼Œå“åº”çš„ä»£ç†å¯¹è±¡å’Œä¾èµ–çš„æ“ä½œï¼Œä¹Ÿæ˜¯æ¯”è¾ƒæ ¸å¿ƒçš„ä¸€ä¸ªæ¨¡å—ã€‚
é¦–å…ˆï¼Œæˆ‘ä»¬è¦å®ç°ä¸¤ä¸ªæ ¸å¿ƒå‡½æ•°<code>æ”¶é›†track</code>å’Œ<code>è§¦å‘trigger</code>ï¼Œ
å…¶æ¬¡ï¼Œæˆ‘ä»¬è¦æ˜ç™½effectå¹²äº†ä»€ä¹ˆ
ç…§æ—§ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹æµ‹è¯•ç”¨ä¾‹å’‹ä½¿ç”¨ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">describe</span><span class="p">(</span><span class="s2">&#34;effect&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;Happy path&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">origin</span> <span class="o">=</span> <span class="nx">reactive</span><span class="p">({</span>
      <span class="s1">&#39;age&#39;</span><span class="o">:</span> <span class="mi">10</span>
    <span class="p">})</span>

    <span class="kd">let</span> <span class="nx">nextAge</span>
    <span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">nextAge</span> <span class="o">=</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">age</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="p">})</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">nextAge</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>

    <span class="nx">origin</span><span class="p">.</span><span class="nx">age</span> <span class="o">=</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">age</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">nextAge</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
  <span class="p">});</span>
<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çŸ¥é“ï¼š</p>
<ol>
<li>effectä¸­çš„å›è°ƒä¼šè§¦å‘æ”¶é›†ä¾èµ–ï¼Œå¹¶ä¼šè¢«ç«‹åˆ»æ‰§è¡Œä¸€æ¬¡</li>
<li>å½“å›è°ƒä¸­çš„å…³è”çš„å“åº”å¼å¯¹è±¡çš„å€¼æ”¹å˜æ—¶ï¼Œä¼šé‡æ–°è§¦å‘ä»¥æ¥æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯å†æ¬¡æ‰§è¡Œeffectä¸­ä¼ é€’çš„å›è°ƒå‡½æ•°</li>
</ol>
<p>æ¥ä¸‹æ¥<code>src/reactivity</code>ç›®å½•ä¸‹åˆ›å»º<code>effect.ts</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="c1">// effect.ts
</span><span class="c1">// è¿™æ˜¯æ‰€è°“çš„ä¾èµ–çš„æ ¸å¿ƒ
</span><span class="c1"></span><span class="kr">class</span> <span class="nx">ReactiveEffect</span> <span class="p">{</span>
  <span class="kr">private</span> <span class="nx">_fn</span><span class="o">:</span> <span class="nx">any</span>
  <span class="nx">constructor</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_fn</span> <span class="o">=</span> <span class="nx">fn</span>
  <span class="p">}</span>
  <span class="nx">run</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// è¿™ä¸ªå‡½æ•°ä¼šæ‰§è¡Œä¼ é€’çš„fnï¼Œå¹¶æŠŠå½“å‰thisèµ‹å€¼ç»™å…¨å±€activeEffect
</span><span class="c1"></span>    <span class="nx">activeEffect</span> <span class="o">=</span> <span class="k">this</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_fn</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// å…¨å±€çš„å¯¹è±¡æ¥æ”¶é›†ä¾èµ–ï¼Œå…¶å®å°±æ˜¯ReactiveEffectå¯¹è±¡
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">activeEffect</span>

<span class="kd">function</span> <span class="nx">effect</span> <span class="p">(</span><span class="nx">fn</span><span class="o">:</span> <span class="nb">Function</span> <span class="p">)</span> <span class="p">{</span>
  <span class="c1">//ä¸ºäº†æ›´å¥½çš„å¤„ç†fnç›¸å…³é€»è¾‘ï¼Œéœ€è¦ä¸€ä¸ªreactiveEffectç±» åšæŠ½è±¡
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">_effect</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReactiveEffect</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span>
  <span class="nx">_effect</span><span class="p">.</span><span class="nx">run</span><span class="p">()</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="p">{</span>
  <span class="nx">effect</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä»¥ä¸Šå°±å®ç°äº†effectä¸­çš„å›è°ƒä¼šè¢«ç«‹åˆ»æ‰§è¡Œä¸€æ¬¡ï¼Œæ¥ä¸‹æ¥åˆ†æä¾èµ–æ”¶é›†ä¸è§¦å‘ï¼Œå…ˆçœ‹æˆ‘ä»¬æ€ä¹ˆå®šä¹‰ä¾èµ–å­˜å‚¨çš„æ•°æ®ç»“æ„
æˆ‘ä»¬ç°åœ¨æœ‰ä¸‰çº§å…³ç³»éœ€è¦å¤„ç†ï¼Œå¯¹åº”çš„éœ€è¦ä¸‰ä¸ªæ•°æ®ç»“æ„æ¥å­˜å‚¨ï¼š
<code>target(åŸå§‹å¯¹è±¡) -&gt; key(åŸå§‹å¯¹è±¡çš„key) -&gt; deps(ä¾èµ–å¯¹è±¡ï¼Œå³ä¸Šé¢çš„activeEffectå…¨å±€å¯¹è±¡)</code></p>
<ol>
<li>å¯¹äº<code>target -&gt; key</code>çš„å…³ç³»æˆ‘ä»¬åªèƒ½ä½¿ç”¨<code>Mapæˆ–è€…WeakMap</code>æ•°æ®ç»“æ„æ¥å­˜å‚¨ï¼Œè¿™ä¸¤ç§æ•°æ®ç»“æ„çš„keyå¯ä»¥æ˜¯å¯¹è±¡ï¼Œä½†<code>WeakMap</code>å¾—keyåªèƒ½æ˜¯å¯¹è±¡ï¼Œè€Œæ™®é€š<code>object</code>çš„<code>key</code>åªèƒ½æ˜¯<code>string</code>æˆ–è€…<code>Symbol</code>ï¼Œ</li>
<li>ç¬¬ä¸€å±‚<code>map</code>çš„<code>value</code>æ˜¯ä»£è¡¨<code>key -&gt; deps</code>çš„å…³ç³»ï¼Œä¹Ÿå¿…é¡»è¦ç”¨<code>map</code>æ¥å­˜å‚¨</li>
<li>å¯¹äº<code>deps</code>æ¥è¯´ï¼Œå­˜åœ¨å¤šä¸ªä¾èµ–ä½†æ˜¯å¿…é¡»ä¸èƒ½é‡å¤ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨<code>Set</code>æ•°æ®ç»“æ„å­˜å‚¨ã€‚
ä»¥ä¸Šå°±æ˜¯ä¸‰å±‚æ•°æ®ç»“æ„çš„é€‰æ‹©ï¼Œç”¨ä¸€ä¸ªç®€å›¾æè¿°çš„è¯å°±æ˜¯ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="o">:</span> <span class="nx">foo</span><span class="p">,</span> <span class="s1">&#39;foo2&#39;</span><span class="o">:</span> <span class="nx">foo2</span><span class="p">}</span> <span class="o">:</span> <span class="p">{</span>
    <span class="s1">&#39;foo&#39;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">(...),</span>
    <span class="s1">&#39;foo2&#39;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">(...),</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç®€å•æ¦‚æ‹¬æ¥è¯´å°±æ˜¯ï¼š</p>
<ul>
<li>targetæ˜¯ä¸€ä¸ªç®€å•å¯¹è±¡<code>{'foo': foo, 'foo2': foo2}</code>,ä½œä¸ºç¬¬ä¸€ä¸ªmapçš„key</li>
<li>valueæ˜¯ç¬¬äºŒä¸ªmapï¼Œç®€å•å¯¹è±¡çš„keyä½œä¸ºè¿™ä¸ªmapçš„key</li>
<li>ç¬¬äºŒä¸ªmapçš„valueå°±æ˜¯å­˜å‚¨<code>activeEffectå…¨å±€å¯¹è±¡</code>çš„set</li>
</ul>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å®ç°<code>track</code>å‡½æ•°äº†ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="c1">// effect.ts
</span><span class="c1"></span>
<span class="c1">// æ„å»ºç¬¬ä¸€å±‚Mapï¼Œæœ€å¤–å±‚çš„å…¨å±€å˜é‡
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">targetMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WeakMap</span><span class="p">()</span>
<span class="kd">function</span> <span class="nx">track</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">depsMap</span> <span class="o">=</span> <span class="nx">targetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">depsMap</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// æ„å»ºç¬¬2å±‚Map
</span><span class="c1"></span>    <span class="nx">depsMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WeakMap</span><span class="p">()</span>
    <span class="nx">targetMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">depsMap</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">depsSet</span> <span class="o">=</span> <span class="nx">depsMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">depsSet</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// æ„å»ºç¬¬3å±‚Set
</span><span class="c1"></span>    <span class="nx">depsSet</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">()</span>
    <span class="nx">depsSet</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">depsSet</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">depsSet</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">activeEffect</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ”¶é›†å®Œä¾èµ–åï¼Œæˆ‘ä»¬è§¦å‘ä¾èµ–æ—¶å°±æ˜¯ä¸‰å±‚å±‚å±‚é€’è¿›çš„å»è·å–<code>activeEffect</code>ï¼Œå¹¶æœ€ç»ˆæ‰§è¡Œè¿™ä¸ªå®ä¾‹ä¸Šçš„runæ–¹æ³•ï¼Œå°±ç›¸å½“äºå†æ¬¡æ‰§è¡Œäº†<code>effectä¸­çš„fn</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="c1">// effect.ts
</span><span class="c1"></span>
<span class="kd">function</span> <span class="nx">trigger</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">depsMap</span> <span class="o">=</span> <span class="nx">targetMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
  <span class="c1">// å¦‚æœè¿™é‡Œéƒ½æ‰¾ä¸åˆ°ç¬¬äºŒå±‚çš„ä¾èµ–Mapè‚¯å®šæ˜¯å‰é¢é€»è¾‘æœ‰é—®é¢˜
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">depsMap</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringfy</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="nx">çš„ä¾èµ–æ‰¾ä¸åˆ°</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">depsSet</span> <span class="o">=</span> <span class="nx">depsMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="c1">// éå†setï¼Œæ‰§è¡Œå­˜å‚¨çš„activeEffectçš„runæ–¹æ³•
</span><span class="c1"></span>  <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">activeEffect</span> <span class="k">of</span> <span class="nx">depsSet</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">activeEffect</span><span class="p">.</span><span class="nx">run</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">æ–‡ç« ä½œè€…</span>
    <span class="item-content">å´å°‘æ—</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">ä¸Šæ¬¡æ›´æ–°</span>
    <span class="item-content">
        2022-10-08
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">è®¸å¯åè®®</span>
    <span class="item-content">MIT</span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/vue3/">vue3</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">
            <span class="next-text nav-default">åå°ç®¡ç†ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–</span>
            <span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:wslsdust@163.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/codevvvv9" class="iconfont icon-github" title="github"></a>
  <a href="http://wushao666.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    ç”± <a class="hexo-link" href="https://gohugo.io">Hugo</a> å¼ºåŠ›é©±åŠ¨
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    ä¸»é¢˜ - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span>å´å°‘æ—</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
